#!/usr/bin/env bash
set -x

# ============================================================================================ #
#: Title           : setx                                                                      #
#: Sypnosis        : setx [OPTION] [FILE]                                                      #
#: Date Created    : Tue May 31 15:59:31 PHT 2016 / Tue May 31 07:59:31 UTC 2016               #
#: Last Edit       : Wed Jun  1 12:23:45 PHT 2016 / Wed Jun  1 04:23:45 UTC 2016               #
#: License         : GPLv3                                                                     #
#: Version         : 1.0.0                                                                     #
#: Author          : Jason V. Ferrer '<jetchisel@opensuse.org>'                                #
#: Description     : Insert/Add 'set -x' on the second line/after the shebang.                 #
#: Options         : [-i|--insert] [-d|--delete] [-h|?|--help]                                 #
#: Home Page       : NONE                                                                      #
#: ExtComm         : ed,file                                                                   #
# ============================================================================================ #

# ******************************************************************************************** #
#                                                                                              #
#   Warn and die functions, for exit messages and default status or an optional exit status.   #
#                                                                                              #
# ******************************************************************************************** #

warn() {
  printf '%s\n' "${BASH_SOURCE##*/}: $*" >&2
}

die() {
  local st=0
  case $2 in
    *[^0-9]*|'') :;;
    *) st=$2;;
  esac
  warn "$1"
  exit "$st"
}

# ******************************************************************************************** #
#                                                                                              #
#          Check for the required app/executable is with in your PATH, exit otherwise.         #
#                                                                                              #
# ******************************************************************************************** #

Missing=()
ExtComm=(ed file)
MissingMessage="is either not installed or it is not in your PATH!"
ExitMessage="Please install the following: "

for apps in "${ExtComm[@]}"; do
  if ! type -P "$apps" >/dev/null; then
    echo "$apps $MissingMessage" >&2
    Missing+=("$apps")
  fi
done

(( ${#Missing[@]} )) && die "$ExitMessage[${Missing[*]}] exiting now!" 127

# ******************************************************************************************** #
#                                                                                              #
#                                     The help/usage menu.                                     #
#                                                                                              #
# ******************************************************************************************** #

ShowHelp() {
   cat <<EOF

Usage: ${BASH_SOURCE##*/} OPTION FILE

Options:
  -i, --insert   Insert 'set -x' at the second line after the shebang.
  -d, --delete   Removed 'set -x' at the second line after the shebang.
  -h, --help     Show this help.
  -a, --about    A brief info.
  -l, --license  Show license.

EOF
return
}

# ******************************************************************************************** #
#                                                                                              #
#             Continue looping through the arguments/options until there are none.             #
#                                                                                              #
# ******************************************************************************************** #

while (($#)); do 
  if (( $# < 2 )); then 
    ShowHelp 
    exit 1 
  fi
  
  [[ $(file --mime-type -b -- $2) != text* ]] && die "$2 is not a text file!"
  
  { read -r first; read -r second ; } < "$2"
  
  if [[ ${first:0:2} != '#!' || $first != *@(bash|ash|sh|ksh|zsh) ]]; then
    die "$2 does not have a shebang!"
  fi

  case $1 in
    -i|--insert) 
        [[ $second = 'set -x' ]] && die "$2 is already in debug mode!" 1 
        
        if printf '%s\n' '2i' 'set -x' . w q | ed -s "$2"; then
          die "Successfully added 'set -x' after the shebang!" 0
        fi
        ;;
    -d|--delete) 
        if [[ $second = 'set -x' ]]; then 
          if printf '%s\n' '2d' w q | ed -s "$2"; then
            die "Removed 'set -x' after the shebang!" 0
          fi
        else 
          die "$2 is not in debug mode, nothing to remove!" 1
        fi
        ;;
    -h|\?|--help) ShowHelp
        exit 0
        ;;
     *) ShowHelp
        exit 0
        ;;
  esac
done

# ******************************************************************************************** #
#                                                                                              #
#                   Show usage/help menu if no option or argument is given.                    #
#                                                                                              #
# ******************************************************************************************** #

ShowHelp

# ******************************************************************************************** #
#                                                                                              #
#                                    Set the exit staus.                                       #
#                                                                                              #
# ******************************************************************************************** #

exit 0

# ============================================================================================ #
#                                                                                              #
#                                   >>> END OF SCRIPT <<<                                      #
#                                                                                              #
# ============================================================================================ #
