#!/usr/bin/env bash

shopt -s extglob

# ============================================================================================ #
#: Title           : setx                                                                      #
#: Sypnosis        : setx [OPTION] [FILE]                                                      #
#: Date Created    : Tue May 31 15:59:31 PHT 2016 / Tue May 31 07:59:31 UTC 2016               #
#: Last Edit       : Mon Jun 20 14:34:31 PHT 2016 / Mon Jun 20 06:34:31 UTC 2016               #
#: License         : GPLv3                                                                     #
#: Version         : 1.3.0                                                                     #
#: Author          : Jason V. Ferrer '<jetchisel@opensuse.org>'                                #
#: Description     : Insert/Add `Debug code' on the second line/after the shebang.             #
#: Options         : [-x|--xtrace] [-s|--step] [-u|--undo] [-h|?|--help] [-a|--about]          #
#: Home Page       : NONE                                                                      #
#: ExtComm         : cat,ed,file,grep                                                          #
# ============================================================================================ #

# ******************************************************************************************** #
#                                                                                              #
#   Warn and die functions, for exit messages and default status or an optional exit status.   #
#                                                                                              #
# ******************************************************************************************** #

warn() {
  printf '%s\n' "${BASH_SOURCE##*/}: $*" 
}

die() {
  local st=$? 
  case $2 in  
    *[^0-9]*|'') :;; 
    *) st=$2;; 
  esac

  case $st in 
    0) warn "$1" ;;  
    *) warn "$1" >&2;; 
  esac

  exit "$st"  
} 

# ******************************************************************************************** #
#                                                                                              #
#          Check for the required app/executable is with in your PATH, exit otherwise.         #
#                                                                                              #
# ******************************************************************************************** #

Missing=()
ExtComm=(ed file)
MissingMessage="is either not installed or it is not in your PATH!"
ExitMessage="Please install the following: "

for apps in "${ExtComm[@]}"; do
  if ! type -P "$apps" >/dev/null; then
    printf '%s %s\n' "$apps" "$MissingMessage" >&2
    Missing+=("$apps")
  fi
done

(( ${#Missing[@]} )) && die "$ExitMessage[${Missing[*]}] exiting now!" 127

# ******************************************************************************************** #
#                                                                                              #
#                                     The help/usage menu.                                     #
#                                                                                              #
# ******************************************************************************************** #

ShowHelp() {
   cat <<EOF

Usage: ${BASH_SOURCE##*/} OPTION FILE

Options:
  -s, --step     Make the execution of script slower using a trap.
  -u, --undo     Undo or remove all the \`debug' code in the script.
  -x, --xtrace   Add \`set -x' and \`PS4' debug code below the shebang.
  -h, --help     Show this help.
  -a, --about    A brief info.

EOF
}

# ******************************************************************************************** #
#                                                                                              #
#                     Show the help/usage if no option/arguments is given.                     #
#                                                                                              #
# ******************************************************************************************** #

if ((!$#)); then
  ShowHelp >&2
  exit 1
fi

# ******************************************************************************************** #
#                                                                                              #
#                        Function to print some info about the script.                         #
#                                                                                              #
# ******************************************************************************************** #

About() {
   cat <<EOF

                           setx

Copyright  (c)  2016 Jason V. Ferrer '<jetchisel@opensuse.org>'

A bash shell  script  that inserts \`set -x' and a \`PS4' debug 
code or a trap to make the script execute line by line by using 
the  return  key.  Shell  script is  more verbose when the code
is  added in the script in question. This script  requires  the 
follwing  GNU utilities, ed(1) for editing the shell script and
file(1)  for  testing  file type of the script in question and.
grep for matching patterns against the debug codes.

This  program is free software;  you can redistribute it and/or
modify  it  under the terms  of the  GNU General Public License
version 3 as published by the Free Software Foundation.

This program is distributed in the hope that it will be useful,
but WITHOUT  ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY  or  FITNESS  FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

EOF
}

# ******************************************************************************************** #
#                                                                                              #
#                                       Some variables.                                        #
#                                                                                              #
# ******************************************************************************************** #

FiLe=$2 
setxcode='set -x  #_S_E_T_X_#'
ps4code='PS4='\''+($?) $BASH_SOURCE:$FUNCNAME:$LINENO:'\''  #_P_S_4_#'
stepcode='trap '\''(read -p "[$BASH_SOURCE:$LINENO] $BASH_COMMAND? ")'\'' DEBUG  #_S_T_E_P_#'

# ******************************************************************************************** #
#                                                                                              #
#                              Function to insert the debug code.                              #
#                                                                                              #
# ******************************************************************************************** #

InsertX() {
  local SetxCode LineNumber
  LineNumber=$1

  SetxCode=(
    "$ps4code"
    "$setxcode"
  ) 

  printf '%s\n' H "$LineNumber" "${SetxCode[@]}" . w q | ed -s "$FiLe"
}

# ******************************************************************************************** #
#                                                                                              #
#                    Function to undo/remove the debug `set -x' `PS4' code.                    #
#                                                                                              #
# ******************************************************************************************** #

UndoInsertX() { 
  printf '%s\n' H 'g/^set -x.*#_S_E_T_X_#$/d' w q | ed -s "$FiLe"
}

# ******************************************************************************************** #
#                                                                                              #
#                           Function to undo/remove the `PS4' code.                            #
#                                                                                              #
# ******************************************************************************************** #

UndoInsertPs4() {
  printf '%s\n' H 'g/^PS4=.*#_P_S_4_#$/d' w q | ed -s "$FiLe"
}

# ******************************************************************************************** #
#                                                                                              #
#                            Function to add/insert `step-up' code.                            #
#                                                                                              #
# ******************************************************************************************** #

InsertStep() {
  local LineNumber
  LineNumber=$1

  printf '%s\n' H "$LineNumber" "$stepcode" . w q | ed -s "$FiLe"

}

# ******************************************************************************************** #
#                                                                                              #
#                            Function to undo/remove the `step-up'.                            #
#                                                                                              #
# ******************************************************************************************** #

UndoInsertStep() {
  printf '%s\n' H 'g/^trap.\+read.\+DEBUG.\+#_S_T_E_P_#$/d' w q | ed -s "$FiLe"
}

# ******************************************************************************************** #
#                                                                                              #
#      Function to do some various if not extensive testing about the file type of `$2'.       #
#                                                                                              #
# ******************************************************************************************** #

TestFile() {
  File=\`"$FiLe"\' 
  FileType=$(file --mime-type -b -- "$FiLe") 
  
  [[ $FileType = "cannot open $File (No such file or directory)" ]] && die "$FileType" 1 
  [[ $FileType = "cannot open $File (Permission denied)" ]] && die "$FileType" 1
  [[ $FileType = "inode/x-empty" ]] && die "$File is an empty file!" 1
  [[ $FileType = text* ]] || die "File type of $File is $FileType" 1
  
  [[ -w $FiLe ]] || die "cannot write to $File (Permission denied)" 1
  [[ -r $FiLe ]] || die "cannot read $File (Permission denied)" 1
  TotalLines=$(ed -s "$FiLe" <<< $'$=') 
  
  { read -r first; read -r second ; } < "$FiLe"
}

# ******************************************************************************************** #
#                                                                                              #
#           Loop through the command line input (arguments/options) and process it.            #
#                                                                                              #
# ******************************************************************************************** #

while (($#)); do
  case $1 in
    -a|--about)
        (( $# > 1 )) && die "Invalid option!, try: \`--help'" 1
        About
        exit
        ;;
    -h|-\?|--help)
        (( $# > 1 )) && die "Invalid option!, try: \`--help'" 1
        ShowHelp
        exit
        ;;
    -s|--step)
        [[ ! "$FiLe" ]] && die "No script is given!, try: \`--help'" 1
        TestFile 
        grep -Fq "$stepcode" "$FiLe" && die "$FiLe is already in \`step mode'!" 
        if (( TotalLines == 1 )); then 
          InsertStep '$a' && die "Successfully added \`step code' after the shebang of $File" 0
        else 
          InsertStep '2i' && die "Successfully added \`step code' after the shebang of $File" 0
        fi
        ;;
    -x|--xtrace)
        [[ ! "$FiLe" ]] && die "No script is given!, try: \`--help'" 1
        TestFile
        grep -Fq "$ps4code" "$FiLe" && die "$File is already in \`debug mode'!" 1 
        if (( TotalLines == 1 )); then
          InsertX '$a' && die "Successfully added debug after the shebang of $File" 0
        else
          InsertX '2i' && die "Successfully added debug after the shebang of $File" 0
        fi
        ;;
    -u|--undo)
        [[ ! "$FiLe" ]] && die "No script is given!, try: \`--help'" 1
        TestFile
        grep -Fq "$stepcode" "$FiLe" && UndoInsertStep 
        grep -Fq "$setxcode" "$FiLe" && UndoInsertX    
        grep -Fq "$ps4code" "$FiLe" && UndoInsertPs4   
        
        die "If there were \`debug' codes that was added from $FiLe, it has been removed." 0 
        ;;
     *) ShowHelp >&2
        exit 1
        ;; 
  esac
done

# ============================================================================================ #
#                                                                                              #
#                                   >>> END OF SCRIPT <<<                                      #
#                                                                                              #
# ============================================================================================ #
